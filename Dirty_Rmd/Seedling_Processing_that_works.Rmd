---
title: "Seedling_processing2.0"
author: "Bryce DiNardo"
date: "2025-11-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rFIA)
library(dplyr)
library(sf)
library(terra)
library(ggplot2)
```

## I hope this works
Right now just looking to get 2022 Douglas-fir TPA and then join with lat long by plot to make a map 
Get the data tables load up and clip to just the most recent invenotry year set 2012-2022
```{r cars}
or_fia <- readFIA("C:/Users/Bryce/OneDrive - University Of Oregon/FIA", nCores = 4)
or_fia_clip <- clipFIA(or_fia, mostRecent = TRUE)
```
Filter SEEDLING table to get douglas-fir and inventory year 2022
```{r}
head(or_fia_clip$POP_STRATUM)

Seedling_df<-or_fia_clip$SEEDLING %>% 
  filter(SPCD == 202, INVYR == 2022, !is.na(TREECOUNT_CALC), TREECOUNT_CALC > 0) %>% 
  select(PLT_CN, SUBP, CONDID, INVYR, SPCD, TREECOUNT_CALC, TPA_UNADJ)

head(Seedling_df)

Seedling_df %>% 
  filter(PLT_CN == 823110394290487)

```
To calculate TPA (trees per acre) for each plot, we first tidy the seedling data by filtering for Douglas-fir (SPCD == 202) in the 2022 inventory. Each row represents a subplot (SUBP) within a plot (PLT_CN), and includes an estimate of seedling density (TPA_UNADJ) for that subplot.
Since each plot typically contains four subplots (SUBP 1–4), we sum the TPA_UNADJ values across all subplots that share the same PLT_CN. This gives us the total seedling density (TPA) for Douglas-fir in each plot, expressed in trees per acre.
```{r}
Seedling_tpa<-Seedling_df %>% 
  group_by(PLT_CN) %>% 
  summarise(TPA = mean (TPA_UNADJ, na.rm = TRUE))
```
We see a lot of 74.96528 and 149.93057, that is bacasue the expansiton factor is for every 1 seedling in mircoplot there is 74.96528 seedlings in the acre, so lots of plots of plot have just 1 or 2 seedlings


Next I need to join the plot coordinates to the TPA calculations 
```{r}
or_fia_clip$PLOT
#Get PLT_CN, LAT, LON 
plot_coords <- or_fia_clip$PLOT %>%
  filter(INVYR == 2022) %>% 
  select(PLT_CN, LAT, LON, ELEV) %>%
  filter(!is.na(LAT), !is.na(LON), !is.na(ELEV))
#Join the two tables
seedling_df_latlong<-left_join(Seedling_tpa, plot_coords, by = "PLT_CN") %>% filter(!is.na(TPA), TPA > 0)


```
Currently I now have lat, long, and elevation, need to add landowner from COND by plot_CN
```{r}
head(or_fia$COND)
COND_grp<-or_fia$COND %>% 
  filter(INVYR == 2022) %>% 
  select(PLT_CN,OWNCD, OWNGRPCD)
head(COND_grp)
sum(is.na(COND_grp$OWNCD))
sum(is.na(COND_grp$OWNGRPCD))
```
Very nice, let try to join
```{r}
seedling_df_ready<-left_join(seedling_df_latlong, COND_grp, by = "PLT_CN") 
seedling_df_ready
```

Sweet now I have 2022 Douglas fir seedling TPA per a plot with lat long coordinatrs 
Now I need to make the data table into a shape file, and make sure the datum is correct, their taken in  NAD 83 datum. The approximate latitude of the plot in decimal degrees using NAD 83 datum, but our climate data is in WG 84 so we use crs 4326 which is WGS 84
```{r}
#Making our table a spacial feature
seedling_sf <- st_as_sf(seedling_df_ready, coords = c("LON", "LAT"), crs = 4326)
```
##STOP eveything below is not need, are this point you are read to run analyisi
Play with visulaization

```{r}
#Visualize
plot(seedling_spatial["TPA"], main = "Douglas-fir Seedling Density by Plot")
#Histogram of data
ggplot(seedling_spatial, aes(x = TPA)) +
  geom_histogram(binwidth = 100, fill = "forestgreen", color = "white") +
  labs(
    title = "Histogram of Douglas-fir Seedling Density (TPA)",
    x = "Trees per Acre (TPA)",
    y = "Number of Plots"
  ) +
  theme_minimal()
#Scale log 10
ggplot(seedling_spatial, aes(x = TPA)) +
  geom_histogram(binwidth = 0.1, fill = "forestgreen", color = "white") +
  scale_x_log10() +
  labs(
    title = "Log-Scaled Histogram of Douglas-fir Seedling Density (TPA)",
    x = "Trees per Acre (log10 scale)",
    y = "Number of Plots"
  ) +
  theme_minimal()

```

```{r}
# Create a raster template based on the extent of your spatial points
template_raster <- rast(
  extent = ext(seedling_sf),
  resolution = 0.01,  # ~1 km pixels; adjust as needed
  crs = "EPSG:4326"   # Matches your sf object (WGS84)
)

tpa_raster <- rasterize(
  seedling_sf,
  template_raster,
  field = "TPA",
  fun = "mean"  # Averages TPA if multiple plots fall in the same pixel
)

plot(tpa_raster, main = "Douglas-fir Seedling Density (TPA) — Oregon 2022")

```
Messing with getting them to be within oregons boundry
```{r}
# Get all US states as sf
states_sf <- tigris::states(year = 2024)

# Filter for Oregon
oregon <- states_sf[states_sf$NAME == "Oregon", ] %>%
  st_transform(crs = 4326)  # Match CRS of your seedling_sf

seedling_or <- seedling_sf[oregon, ]  # spatial filter using sf geometry

template_raster <- rast(ext(oregon), resolution = 0.01, crs = "EPSG:4326")

tpa_raster <- rasterize(seedling_or, template_raster, field = "TPA", fun = "mean") 

plot(tpa_raster, main = "Douglas-fir Seedling Density (TPA) — Oregon 2022")
plot(st_geometry(oregon), add = TRUE, border = "black", lwd = 1.5)
plot(st_geometry(seedling_or), add = TRUE, pch = 16, col = "darkgreen", cex = 0.5)

```
```{r}
# Count how many plots fall into each raster cell
plot_count_raster <- rasterize(
  seedling_or,           # your sf object
  template_raster,       # same raster template
  fun = "count"          # counts number of points per cell
)
df<-as.data.frame(plot_count_raster, xy = TRUE)
summary(df$count)
table(df$count)

```


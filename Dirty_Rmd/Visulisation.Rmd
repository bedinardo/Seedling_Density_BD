---
title: "Data_Visulization"
author: "Bryce DiNardo"
date: "2025-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rFIA)
library(dplyr)
library(sf)
library(terra)
library(ggplot2)
library(ranger)
library(purrr)
set.seed(123)
```

##Start making sense of these random forests
Have to build a function that will allow me to grab all my save .rds ranger outputs and then start interpenetrating them.

This first function will help summarize what the main driver of predicting TPA are in each year species combo
```{r}
#Takes species name, year, and directory, present to where I have .rds files saved
summarize_model <- function(species_name, year,
                            model_dir = "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Ranger_Outputs") {
  #go get file and load it
  model_file <- file.path(model_dir, paste0("rf_model_", species_name, "_", year, ".rds"))
  m<-readRDS(model_file)

#Now need to read the outputs from the model
#OOB
  r2 <- m$r.squared
  rmse <- sqrt(m$prediction.error)
# Variable importance
  vi <- tibble(
    predictor = names(m$variable.importance),
    importance = as.numeric(m$variable.importance)
  )
# Top predictor
  top_pred <- vi %>% slice_max(order_by = importance, n = 1, with_ties = FALSE)
  
  # Return tidy summary row with nested importance
  tibble(
    species = species_name,
    year = year,
    r2 = r2,
    rmse = rmse,
    top_predictor = top_pred$predictor,
    top_importance = top_pred$importance,
    varimp = list(vi)   # nested tibble for easy unnesting later
  )
}

#Do with all utilizig the purrr package and map_df() function 
# Apply across all species-years
species <- c("Douglas_Fir","Western_Hemlock","Lodge_Pole")
years <- 2014:2022

models_summary <- map_df(species, function(sp) {
  map_df(years, function(yr) summarize_model(sp, yr))
})

# Quick look
print(models_summary, n = Inf)


```
Lets plot the occurrence of each top predictor with each species
```{r}
top_counts <- models_summary %>%
  count(species, top_predictor)
top_counts <- top_counts %>%
  group_by(top_predictor) %>%
  mutate(total_n = sum(n)) %>%
  ungroup() %>%
  arrange(desc(total_n))


```
graph it
```{r}
ggplot(top_counts, aes(x = reorder(top_predictor, -total_n), y = n, fill = species)) +
  geom_col(position = "stack")

```
Look at the whole table: I see that there are a bunch of predictors that are close ... how to show all this data
```{r}
library(tidyr)
varimp_long <- models_summary %>% unnest(varimp)
head(varimp_long)

```
Options
Just for species year, I thik this looks nice and is a good overview for a single year species combo
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir", year == 2014),
       aes(x = importance, y = reorder(predictor, importance), fill = predictor)) +
  geom_col() +
  labs(title = "Douglas Fir 2014 — Variable Importance",
       x = "Permutation importance", y = NULL) +
  theme_minimal()

```
This one is good too, based on species, including all years, which predictors are consistinly imporantant year to year
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir"),
       aes(x = predictor, y = importance, fill = predictor)) +
  geom_boxplot() +
  labs(title = "Douglas Fir — Importance distribution across years",
       y = "Permutation importance") +
  theme_minimal()

```
Looks how vairale imporantace changes year to year
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir"),
       aes(x = year, y = importance, color = predictor)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Douglas Fir — Importance over time",
       y = "Permutation importance") +
  theme_minimal()

```
Line graph but as a heat map
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir"),
       aes(x = factor(year), y = predictor, fill = importance)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "C") +
  labs(title = "Douglas Fir — Predictor importance heat map",
       x = "Year", y = "Predictor", fill = "Importance") +
  theme_minimal()

```


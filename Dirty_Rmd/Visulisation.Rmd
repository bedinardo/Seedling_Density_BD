---
title: "Data_Visulization"
author: "Bryce DiNardo"
date: "2025-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rFIA)
library(dplyr)
library(sf)
library(terra)
library(ggplot2)
library(ranger)
library(purrr)
set.seed(123)
```

##Start making sense of these random forests
Have to build a function that will allow me to grab all my save .rds ranger outputs and then start interpenetrating them.
```{r}
readRDS("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Ranger_Outputs/rf_model_Douglas_Fir_2016.rds")
```

This first function will help summarize what the main driver of predicting TPA are in each year species combo
```{r}
#Takes species name, year, and directory, present to where I have .rds files saved
summarize_model <- function(species_name, year,
                            model_dir = "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Ranger_Outputs") {
  #go get file and load it
  model_file <- file.path(model_dir, paste0("rf_model_", species_name, "_", year, ".rds"))
  m<-readRDS(model_file)

#Now need to read the outputs from the model
#OOB
  r2 <- m$r.squared
  rmse <- sqrt(m$prediction.error)
# Variable importance
  vi <- tibble(
    predictor = names(m$variable.importance),
    importance = as.numeric(m$variable.importance)
  )
# Top predictor
  top_pred <- vi %>% slice_max(order_by = importance, n = 1, with_ties = FALSE)
  
  # Return tidy summary row with nested importance
  tibble(
    species = species_name,
    year = year,
    r2 = r2,
    rmse = rmse,
    top_predictor = top_pred$predictor,
    top_importance = top_pred$importance,
    varimp = list(vi)   # nested tibble for easy unnesting later
  )
}

#Do with all utilizig the purrr package and map_df() function 
# Apply across all species-years
species <- c("Douglas_Fir","Western_Hemlock","Lodge_Pole")
years <- 2014:2022

models_summary <- map_df(species, function(sp) {
  map_df(years, function(yr) summarize_model(sp, yr))
})

# Quick look
print(models_summary, n = Inf)


```
Lets plot the occurrence of each top predictor with each species
```{r}
top_counts <- models_summary %>%
  count(species, top_predictor)
top_counts <- top_counts %>%
  group_by(top_predictor) %>%
  mutate(total_n = sum(n)) %>%
  ungroup() %>%
  arrange(desc(total_n))


```
graph it
```{r}
ggplot(top_counts, aes(x = reorder(top_predictor, -total_n), y = n, fill = species)) +
  geom_col(position = "stack")

```
Look at the whole table: I see that there are a bunch of predictors that are close ... how to show all this data
```{r}
library(tidyr)
varimp_long <- models_summary %>% unnest(varimp)
head(varimp_long)

```
Options
Just for species year, I thik this looks nice and is a good overview for a single year species combo
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir", year == 2014),
       aes(x = importance, y = reorder(predictor, importance), fill = predictor)) +
  geom_col() +
  labs(title = "Douglas Fir 2014 — Variable Importance",
       x = "Permutation importance", y = NULL) +
  theme_minimal()

```
Facet the one above by year
```{r}
predictor_order <- c("OWNGRPCD", "OWNCD", "ELEV", "pr", "tmmn", "tmmx", "tmean")
ggplot(varimp_long %>%
         filter(species == "Douglas_Fir", year >= 2014, year <= 2022) %>%
         mutate(predictor = factor(predictor, levels = predictor_order)),
       aes(x = importance,
           y = predictor,
           fill = predictor)) +
  geom_col(show.legend = FALSE, width = 0.7) +
  facet_wrap(~ year, ncol = 3) +
  labs(title = "Douglas-Fir Variable Importance (2014–2022)",
       x = "Mean decrease in seedling model accuracy",
       y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 12),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 10),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )



```
export
```{r}
ggsave("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/Figures/DouglasFir_VarImp.png", width = 10, height = 7, dpi = 300)

```

A scatter plot with mean and sd of permutation imporantace
```{r}
imporant_mean<-varimp_long %>% 
  filter(species == "Douglas_Fir") %>% 
  group_by(predictor) %>% 
  summarise(mean_importance = mean(importance), sd = sd(importance)) %>% 
  dplyr::mutate(predictor = factor(predictor, levels = predictor_order))

ggplot(imporant_mean, aes(x = predictor, y = mean_importance)) +
  geom_point(size = 4, color = "steelblue") +
  geom_errorbar(aes(ymin = mean_importance - sd,
                    ymax = mean_importance + sd),
                width = 0.2, color = "gray40") +
  labs(title = "Mean Permutation Importance by Predictor (2014–2022)",
       x = "Predictor",
       y = "Mean permutation importance") +
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 12),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold")
  )



```



For hemlock

```{r}
ggplot(varimp_long %>% filter(species == "Western_Hemlock", year >= 2014, year <= 2022),
       aes(x = importance, y = reorder(predictor, importance), fill = predictor)) +
  geom_col() +
  facet_wrap(~ year, ncol = 3) +
  labs(title = "Western Hemlock Variable Importance (2014–2022)",
       x = "Permutation importance",
       y = NULL) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```
Lodge-Pole pine
```{r}
ggplot(varimp_long %>% filter(species == "Lodge_Pole", year >= 2014, year <= 2022),
       aes(x = importance, y = reorder(predictor, importance), fill = predictor)) +
  geom_col() +
  facet_wrap(~ year, ncol = 3) +
  labs(title = "Lodge Pole Pine Variable Importance (2014–2022)",
       x = "Permutation importance",
       y = NULL) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```



This one is good too, based on species, including all years, which predictors are consistinly imporantant year to year
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir"),
       aes(x = predictor, y = importance, fill = predictor)) +
  geom_boxplot() +
  labs(title = "Douglas Fir — Importance distribution across years",
       y = "Permutation importance") +
  theme_minimal()

```
Poster
```{r}
ggplot(varimp_long %>%
         filter(species == "Douglas_Fir") %>%
         mutate(predictor = factor(predictor,
                                   levels = predictor_order,
                                   labels = pretty_names[predictor_order])),
       aes(x = year, y = importance, color = predictor)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Douglas-Fir — Importance Over Time",
    y = "Mean decrease in seedling model accuracy",
    x = "Year",
    color = "Predictor"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    panel.grid.minor = element_blank()
  )

```



Looks how vairale imporantace changes year to year

```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir"),
       aes(x = year, y = importance, color = predictor)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Douglas Fir — Importance over time",
       y = "Permutation importance") +
  theme_minimal()


#hemlock
ggplot(varimp_long %>% filter(species == "Western_Hemlock"),
       aes(x = year, y = importance, color = predictor)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Western Hemlock — Importance over time",
       y = "Permutation importance") +
  theme_minimal()
#lodge pole pine
ggplot(varimp_long %>% filter(species == "Lodge_Pole"),
       aes(x = year, y = importance, color = predictor)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Lodge Pole Pine — Importance over time",
       y = "Permutation importance") +
  theme_minimal()
```
Line graph but as a heat map
```{r}
ggplot(varimp_long %>% filter(species == "Douglas_Fir"),
       aes(x = factor(year), y = predictor, fill = importance)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "C") +
  labs(title = "Douglas Fir — Predictor importance heat map",
       x = "Year", y = "Predictor", fill = "Importance") +
  theme_minimal()

```
Let run these last 3 visulations for hemlock
```{r}
ggplot(varimp_long %>% filter(species == "Western_Hemlock"),
       aes(x = predictor, y = importance, fill = predictor)) +
  geom_boxplot() +
  labs(title = "Western Hemlock — Importance distribution across years",
       y = "Permutation importance") +
  theme_minimal()
```
```{r}
ggplot(varimp_long,
       aes(x = predictor, y = importance, fill = predictor)) +
  geom_boxplot() +
  facet_wrap(~ species, ncol = 1, scales = "free_y") +
  labs(
    title = "Variable Importance Distributions Across Species",
    y = "Permutation importance",
    x = "Predictor"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```
I think permuation important with the current values is a bit hard to understand, so lets turn it into a percentage. However the percentage is relative to the model as a whole. These are not the only varaibles that detemine TPA
```{r}
varimp_pct <- varimp_long %>%
  group_by(species, year) %>%
  mutate(
    importance_pct = importance / sum(importance) * 100
  ) %>%
  ungroup()

```
Graph the percent
```{r}
ggplot(varimp_pct %>% filter(species == "Douglas_Fir"),
       aes(x = predictor, y = importance_pct, fill = predictor)) +
  geom_boxplot() +
  labs(
    title = "Douglas Fir — Relative Predictor Importance Across Years",
    y = "Importance (%) of total",
    x = "Predictor"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

```{r}
top_counts_pct <- varimp_pct %>%
  group_by(species, predictor) %>%
  summarise(mean_pct = mean(importance_pct), .groups = "drop")

ggplot(top_counts_pct,
       aes(x = predictor, y = mean_pct, fill = species)) +
  geom_col(position = "stack") +
  labs(
    title = "Average Relative Importance of Predictors Across Species",
    y = "Mean importance (%)",
    x = "Predictor"
  ) +
  theme_minimal(base_size = 12)

```
Multi species heat map
```{r}
ggplot(varimp_pct,
       aes(x = factor(year), y = predictor, fill = importance_pct)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "C") +
  facet_wrap(~ species, ncol = 1) +
  labs(
    title = "Relative Predictor Importance Across Species and Years",
    x = "Year",
    y = "Predictor",
    fill = "Importance (%)"
  ) +
  theme_minimal(base_size = 12)

```

```{r}
ggplot(models_summary,
       aes(x = r2, y = top_importance, color = top_predictor)) +
  geom_point() +
  labs(title = "Model Fit vs. Top Predictor Importance",
       x = "OOB R²", y = "Top predictor importance")


```

```{r}
ggplot(varimp_pct,
       aes(x = predictor, y = importance_pct, fill = predictor)) +
  geom_boxplot() +
  facet_wrap(~ species, ncol = 1, scales = "free_y") +
  labs(title = "Relative Predictor Importance Across Species")

```
I'm going to make a table that shows max min mean r2 for each species, and then mean rmse, but back transformed to have it in terms of a factor multiler of TPA
```{r}
models_summary
#First get min max mean r2
r2_summarised<-models_summary %>% 
  filter(species == "Douglas_Fir") %>% 
  group_by(species) %>% 
  summarise(min_r2 = min(r2), max_r2 = max(r2), mean_r2 = mean(r2))
  
#Then calc mean rmse and back transform rmse
mean_rmse<-models_summary %>% 
  group_by(species) %>% 
  summarise (mean_rmse_TPA = 10^mean(rmse))

#Join them
summarized_model_preformance<- r2_summarised %>% left_join(mean_rmse, by = "species")
summarized_model_preformance
```
Poster Graphs
Prilimary settings so everything can match 
```{r}
predictor_order <- c("OWNGRPCD", "OWNCD", "ELEV", "pr", "tmmn", "tmmx", "tmean")
predictor_colors <- c(
  "OWNGRPCD" = "#E69F00",  # orange
  "OWNCD"    = "#56B4E9",  # sky blue
  "ELEV"     = "#009E73",  # green
  "pr"       = "#0072B2",  # yellow
  "tmmn"     = "#F0E442",  # blue
  "tmmx"     = "#D55E00",  # reddish orange
  "tmean"    = "#CC79A7"   # purple/pink
)



```

line
```{r}
predictor_order_revers <- c("tmean", "tmmx", "tmmn", "pr", "ELEV", "OWNCD", "OWNGRPCD")
ggplot(varimp_long %>%
         filter(species == "Douglas_Fir") %>%
         mutate(predictor = factor(predictor, levels = predictor_order_revers)),
       aes(x = year, y = importance, color = predictor)) +
  geom_line(size = 1) +
  geom_point(size = 1.2) +
  scale_color_manual(values = predictor_colors) +
  labs(title = "Douglas-Fir — Importance Over Time",
       y = "Mean Decrease in Seedling Model Accuracy",
       x = "Year",
       color = "Predictor") +
  theme_minimal(base_size = 16) +
  theme(
    plot.title   = element_text(face = "bold", size = 18, hjust = 0.5),
    axis.text    = element_text(size = 12),
    axis.title.x = element_text(size = 14, margin = margin(t = 15)),  # move x-axis title down
    axis.title.y = element_text(size = 14, margin = margin(r = 12)),  # move y-axis title left
    legend.title = element_text(size = 14, face = "bold"),
    legend.text  = element_text(size = 12),
    panel.grid.minor = element_blank()
  )



```
Faceted bar
```{r}
ggplot(varimp_long %>%
         filter(species == "Douglas_Fir", year >= 2014, year <= 2022) %>%
         mutate(predictor = factor(predictor, levels = predictor_order)),
       aes(x = importance, y = predictor, fill = predictor)) +
  geom_col(width = 0.7) +
  scale_fill_manual(values = predictor_colors) +
  facet_wrap(~ year, ncol = 3) +
  labs(title = "Douglas-Fir Variable Importance (2014–2022)",
       x = "Mean Decrease in Seedling Model Accuracy",
       y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 12),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12, margin = margin(t = 15)),  # move x-axis label down
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none"
  )

```
Save them
```{r}
ggsave("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/Figures/DouglasFir_box.png", width = 10, height = 7, dpi = 300)
```

scatterplot
```{r}
imporant_mean<-varimp_long %>% 
  filter(species == "Douglas_Fir") %>% 
  group_by(predictor) %>% 
  summarise(mean_importance = mean(importance), sd = sd(importance)) %>% 
  dplyr::mutate(predictor = factor(predictor, levels = predictor_order_revers))

ggplot(imporant_mean, aes(x = predictor, y = mean_importance, color = predictor)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_importance - sd,
                    ymax = mean_importance + sd),
                width = 0.1, color = "gray40") +
  scale_color_manual(values = predictor_colors) +
  labs(title = "Mean Permutation Importance by Predictor (2014–2022)",
       x = "Predictor",
       y = "Mean Permutation Importance") +
  theme_minimal(base_size = 16) +
  theme(
  plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
  axis.text.x = element_text(angle = 30, hjust = 1, size = 12),
  axis.text.y = element_text(size = 12),
  axis.title = element_text(size = 14),
  legend.position = "none",
  plot.margin = margin(t = 10, r = 10, b = 10, l = 10)  # tighter margins
)


```

```{r}
ggplot(imporant_mean %>%
         mutate(predictor = factor(predictor, levels = predictor_order)),
       aes(x = predictor, y = mean_importance, color = predictor)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_importance - sd,
                    ymax = mean_importance + sd),
                width = 0.1, color = "gray40") +
  scale_color_manual(values = predictor_colors) +
  coord_flip() +
  labs(title = "Mean Permutation Importance by Predictor (2014–2022)",
       x = NULL,
       y = "Mean Permutation Importance") +
  theme_minimal(base_size = 16) +
  theme(
    plot.title   = element_text(face = "bold", size = 18, hjust = 0.5),
    axis.text.y  = element_text(size = 12),
    axis.text.x  = element_text(size = 12),
    axis.title.y = element_text(size = 14, margin = margin(r = 10)),   # move y-axis title
    axis.title.x = element_text(size = 14, margin = margin(t = 15)),   # move x-axis title down
    legend.position = "none"
  )

```



```{r}
ggsave("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/Figures/DouglasFir_scatter.png", width = 10, height = 7, dpi = 300)
```

Map maps maps!
map with symbols for species and color for top driver
I need a oregon shape file ( crs wgs 84)
I need to make a big table with all model summary joined with 
```{r}
st_test<-st_read("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Extracted_Seedling_Climate/Douglas_Fir/Douglas_Fir_2019.gpkg")
```


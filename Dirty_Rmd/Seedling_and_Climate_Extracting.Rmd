---
title: "Seedling and Climate Extracting"
author: "Bryce DiNardo"
date: "2025-11-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rFIA)
library(dplyr)
library(sf)
library(terra)
library(ggplot2)
library(ranger)
set.seed(123)
```

##Combind Processed Seedling and climate data, extracting vaiables at specfic point
First need to grab my saved climate .TIFFs based on the year I want
```{r}
get_clim_rasts<-function(year){
  #make the file path that can be used in interations
tmmn_year<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/Tmmn/tmmn_", year, ".tif")
tmmx_year<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/Tmmx/tmmx_", year, ".tif")
tmean_year<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/tmean/tmean_", year, ".tif")
pr_year<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/Pr/pr_", year, ".tif")

#read in the corresponding rasters 
tmmn_rast_year<-rast(tmmn_year)
tmmx_rast_year<-rast(tmmx_year)
tmean_rast_year<-rast(tmean_year)
pr_rast_year<-rast(pr_year)

climate_LyrStack_year<-(c(tmmn_rast_year, tmmx_rast_year, tmean_rast_year, pr_rast_year))
names(climate_LyrStack_year)<-c("tmmn","tmmx","tmean","pr")

return(climate_LyrStack_year)
}

stack_2019<-get_clim_rasts(2019)
nlyr(stack_2019)
```
Now that I have loaded in my wanted I want to take my saved SF with TPA and plot coors of the spcd and yr I want and extract climate variables from rasters 
```{r}
seedling_sf_2019<-st_read("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf/Douglas_Fir_TPA_SF/douglas-fir2019.gpkg")

extracted_2019<-extract(stack_2019,seedling_sf_2019)

combined_df<-seedling_sf_2019 %>% 
  mutate(tmmn = extracted_2019$tmmn,
        tmmx = extracted_2019$tmmx,
        tmean = extracted_2019$tmean,
        pr = extracted_2019$pr)

combined_df <- cbind(seedling_sf_2019, extracted_2019[,-1])

```
Let write a function with it now
```{r}
Climate_extract <- function(year, species_name, spat_stack) {
  # Build file path dynamically from year + species name
  gpkg_file <- file.path(
  "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf",
  species_name,
  paste0(species_name, year, ".gpkg")
)

  
  # Read the sf file
  sf_file <- st_read(gpkg_file, quiet = TRUE)
  
  # Extract climate values from raster stack
  extraction <- terra::extract(spat_stack, sf_file)
  
  # Bind climate values back to sf (drop ID column)
  combined_df <- cbind(sf_file, extraction[,-1])
  
  # Convert ownership codes to factors
  combined_df$OWNCD     <- as.factor(combined_df$OWNCD)
  combined_df$OWNGRPCD  <- as.factor(combined_df$OWNGRPCD)
  
   # Build output folder and file path
  out_dir <- file.path(
    "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Extracted_Seedling_Climate",
    species_name
  )
  out_file <- file.path(out_dir, paste0(species_name, "_", year, ".gpkg"))
  
  # Save to GeoPackage
  st_write(combined_df, out_file, delete_dsn = TRUE, quiet = TRUE)
  
  return(combined_df)
}


Climate_extract(2019, "Douglas_Fir", stack_2019)
```
Combine our two function so I can loop and have a munch if ready to go dataframes for analysis
Takes year and the name of species in quotes and will return a spacial feature with points being plot locations that have TPA for that tree species taken that year, its land owner, elevation, and the tmmn, tmmx, tmean, pr calcauted at the year for that location
```{r}
SeedlingClimate_extract <- function(year, species_name){
  # Build file path dynamically from year + species name
  gpkg_file <- file.path(
  "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf",
  species_name,
  paste0(species_name, year, ".gpkg")
)
#Read in the seedling sf
seedling_file <- st_read(gpkg_file, quiet = TRUE)

#Read in rasts and build climate raster stack
tmmn_file<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/Tmmn/tmmn_", year, ".tif")
tmmx_file<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/Tmmx/tmmx_", year, ".tif")
tmean_file<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/tmean/tmean_", year, ".tif")
pr_file<-paste0("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Processed Climate Tiffs/Pr/pr_", year, ".tif")

#Read the rasts
tmmn_rast<-rast(tmmn_file)
tmmx_rast<-rast(tmmx_file)
tmean_rast<-rast(tmean_file)
pr_rast<-rast(pr_file)

climate_stack<-(c(tmmn_rast, tmmx_rast, tmean_rast, pr_rast))
names(climate_stack)<-c("tmmn","tmmx","tmean","pr")

#Extract climate values 
 clim_vals <- terra::extract(climate_stack, seedling_file)
 
#Bind climate values back to sf (drop ID column)
  combined_sf <- cbind(seedling_file, clim_vals[,-1])
#Ownership codes to factors
  combined_sf$OWNCD    <- as.factor(combined_sf$OWNCD)
  combined_sf$OWNGRPCD <- as.factor(combined_sf$OWNGRPCD)
  
#Save outout
out_dir<-file.path("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Extracted_Seedling_Climate",
    species_name
  )
  out_file <- file.path(out_dir, paste0(species_name, "_", year, ".gpkg"))
  
st_write(combined_sf, out_file, delete_dsn = TRUE, quiet = TRUE)

 return(combined_sf)
}
```
Test
```{r}
SeedlingClimate_extract(2020, "Douglas_Fir")
```
It works, now lets loop through 2014- 2022 for Douglas_Fir
```{r}
year<-2014:2022

for(i in year){
  SeedlingClimate_extract(i, "Douglas_Fir")
}
```
Western_Hemlock
```{r}
year<-2014:2022
for(i in year){
  SeedlingClimate_extract(i, "Western_Hemlock")
}
```
Lodge_Pole
```{r}
for(i in year){
  SeedlingClimate_extract(i, "Lodge_Pole")
}
```


---
title: "Maps"
author: "Bryce DiNardo"
date: "2025-11-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rFIA)
library(dplyr)
library(sf)
library(terra)
library(ggplot2)
library(ranger)
library(purrr)
set.seed(123)
```

## Reorganzing and arranging data and making maps

So in my orginal shp files I made, the file name holds what species and year the data is from, but that isn't found in the data frame itself, so if I want to make a map that can show both plot location, species name, year inventoryed, and its top predictor I need to get a tibble that has name and year with geom points
```{r}
#Have to do this muliple times so best bet is a function
add_sp_yr <- function(species, year) {
  # Build file path to the gpkg
  dir <- file.path(
    "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf",
    species,
    paste0(species, year, ".gpkg")
  )
  
  # Read in the sf object
  sf <- st_read(dir, quiet = TRUE)
  
  # Add species and year columns
  sf <- sf %>%
    mutate(species = species,
           year = year)
  
  return(sf)
}

```
Now I need to loop through all species and years and then smash them into a big tibble and save that tibble
```{r}
species_list <- c("Douglas_Fir", "Western_Hemlock", "Lodge_Pole")
years <- 2014:2022

# Build all combinations
sp_years <- expand.grid(species = species_list, year = years)

# Read and combine
all_sf <- map2_dfr(sp_years$species, sp_years$year, add_sp_yr)

#save my table
st_write(all_sf,
         "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Geom_point_w_sp_yr/all_species_years.gpkg",
         delete_dsn = TRUE)


```
Join my two big tables together by species and year
```{r}
all_sf<-read_sf("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Geom_point_w_sp_yr/all_species_years.gpkg")
map_data <- all_sf %>%
  left_join(models_summary, by = c("species", "year"))
```

Save it
```{r}
st_write(map_data,
         "C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Geom_point_w_sp_yr/model_w_geom.gpkg",
         delete_dsn = TRUE)
colnames(map_data)
```
Lets make a map where color represents year and symbol species with a base layer of oregon, making sure crs match
```{r}
library(tigris)
states_sf <- tigris::states(year = 2024)
oregon_sf <- states_sf %>%
  filter(STUSPS == "OR")
oregon_sf <- st_transform(oregon_sf, st_crs(all_sf))
crs(oregon_sf)
```
Map it
```{r}
ggplot() +
  geom_sf(data = oregon_sf, fill = "gray95", color = "black") +
  geom_sf(data = all_sf,
          aes(color = factor(year), shape = species),
          size = 2, alpha = 0.7) +
  scale_color_viridis_d(option = "C") +
  labs(title = "Seedling Recruitment Plots in Oregon",
       color = "Year", shape = "Species") +
  theme_minimal(base_size = 12)
```
Map by species, with color showing year and symbol top_predictor
```{r}
#Get just douglis fir
Doug_fir<-map_data %>% 
  filter(species == "Douglas_Fir")
#Plot
ggplot() +
  geom_sf(data = oregon_sf, fill = "gray95", color = "black") +
  geom_sf(data = Doug_fir,
          aes(color = factor(year), shape = top_predictor),
          size = 2, alpha = 0.8) +
  scale_color_viridis_d(option = "C") +
  labs(title = "Douglas-Fir Recruitment Plots in Oregon",
       color = "Year",
       shape = "Top Predictor") +
  theme_minimal(base_size = 12)

```
Map for hemlock
```{r}
Doug_fir<-map_data %>% 
  filter(species == "Western_Hemlock")
#Plot
ggplot() +
  geom_sf(data = oregon_sf, fill = "gray95", color = "black") +
  geom_sf(data = Doug_fir,
          aes(color = factor(year), shape = top_predictor),
          size = 2, alpha = 0.8) +
  scale_color_viridis_d(option = "C") +
  labs(title = "Western Hemlock Recruitment Plots in Oregon",
       color = "Year",
       shape = "Top Predictor") +
  theme_minimal(base_size = 12)
```
Lodge Pole
```{r}
lodge_pole<-map_data %>% 
  filter(species == "Lodge_Pole")
#Plot
ggplot() +
  geom_sf(data = oregon_sf, fill = "gray95", color = "black") +
  geom_sf(data = lodge_pole,
          aes(color = factor(year), shape = top_predictor),
          size = 2, alpha = 0.8) +
  scale_color_viridis_d(option = "C") +
  labs(title = "Lodge Pole Pine Recruitment Plots in Oregon",
       color = "Year",
       shape = "Top Predictor") +
  theme_minimal(base_size = 12)
```


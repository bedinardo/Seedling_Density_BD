---
title: "Climate data Gathering"
author: "Bryce DiNardo"
date: "2025-11-07"
output: html_document
---
This document demonstrates how to download daily minimum temperature data 
from gridMET for the year 2020, crop it to Oregon, and calculate the annual mean while keep data as a raster.

Install and load needed packages

```{r}
install.packages("amadeus")
install.packages("tigris")
install.packages("terra")
install.packages("sf")
library(terra)
library(tigris)
library(amadeus)
library(sf)
```

Set director for downloading Gridmat data as a .cd
```{r}
dir <- dir <- ("C:/Users/Bryce/Desktop") #I had trouble bring it right into my repo folder
```

Download the netCDF data file with download_data from gridmat using download_data
```{r}
#Variable == whatever variable you want to download
#Year = year of interest
download_data("gridmet",
              variable = "Minimum Near-Surface Air Temperature",
              year = 2020,
              directory_to_save = dir,
              acknowledgement = TRUE,
              download = TRUE,
              remove_command = TRUE,
              hash = TRUE)

```

Next need to get an Oregon shape file to crop our nation wide data to just our ROI using tigris
```{r}
states_2024 <- tigris::states(year = 2024)
oregon <- states_2024[states_2024$NAME == "Oregon", ]
#plot(oregon) #make sure we succeeded in getting Oregon boundary
```

Now process the .netfile to pull out out wanted data
```{r}
tmmn2020 <- process_covariates(
  covariate = "gridmet",
  variable  = "Minimum Near-Surface Air Temperature",
  date      = c("2020-01-01", "2020-12-31"), #this range gets use the whole year for the whole country
  path      = file.path(dir, "tmmn")
)

# Check structure and number of layers
str(tmmn2020)
nlyr(tmmn2020)  # should be 366 (leap year)
```
Check crs, and reproject tigris data to match climate data projection
Crop and mask our whole year whole country spat raster to just Orgeon
```{r}
# Check CRS of raster
crs(tmmn2020) #WGS84

# Reproject Oregon boundary to match raster CRS
oregon_proj <- terra::project(terra::vect(oregon), crs(tmmn2020))

# Now crop and mask safely
tmmn_or_crop <- terra::crop(tmmn2020, oregon_proj)
tmmn_or_mask <- terra::mask(tmmn_or_crop, oregon_proj)
```

Finally lets take all the rasters and calculate the mean minimum air tempature for the year 2020 taken from all the daily lows. 
```{r}
mean_tmmn_2020_OR <- terra::mean(tmmn_or_mask, na.rm = TRUE)

# Confirm single layer
nlyr(mean_tmmn_2020_OR)

# Plot annual mean raster
terra::plot(mean_tmmn_2020_OR)

```
Temperatures in Kelvin 
In short I 
- Downloaded and processed 366 daily rasters.
- Cropped/masked to Oregon.
- Computed a single annual mean raster.

Now lets see if I can write a function that can do this for any day of the year,
inputs year, directory, state autoset to year 
```{r}
#need to check function still
# Function downloads gridMET data for a given climatic variable and year while placing the download into a directory
gridMET_download <- function(year, variable, dir) {
  
  # 1. Download gridMET data for the year
  download_data("gridmet",
                variable = variable,
                year = year,
                directory_to_save = dir,
                acknowledgement = TRUE,
                download = TRUE,
                remove_command = TRUE,
                hash = TRUE)
}
#test function
gridMET_download(2018,  )
```


New function that is separate from downloading the .nt file 
```{r}
#This function works
#It take the year and directory of the net.cd file that you have saved and computes the mean tmmn
mean_tmmn_OR <- function(year, dir, state_name = "Oregon"){
  states_sf <- tigris::states(year = 2024)
  state_boundary <- states_sf[states_sf$NAME == state_name, ]
  
  # 3. Process covariates for the full year
  tmmn <- process_covariates(
    covariate = "gridmet",
    variable  = "Minimum Near-Surface Air Temperature",
    date      = c(paste0(year, "-01-01"), paste0(year, "-12-31")),
    path      = file.path(dir)
  )
  
  # 4. Reproject state boundary to match raster CRS
  state_proj <- terra::project(terra::vect(state_boundary), crs(tmmn))
  
  # 5. Crop and mask raster to state boundary
  tmmn_crop <- terra::crop(tmmn, state_proj)
  tmmn_mask <- terra::mask(tmmn_crop, state_proj)
  
  # 6. Calculate annual mean
  mean_tmmn <- terra::mean(tmmn_mask, na.rm = TRUE)
  
  return(mean_tmmn)
}
OR_2019<-mean_tmmn_OR(2019, dir2)
nlyr(OR_2019) #check to make sure the merging happened correctly 
terra::plot(OR_2019) #check that it plots 
```



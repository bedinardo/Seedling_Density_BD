---
title: "Get_Seedling"
author: "Bryce DiNardo"
date: "2025-11-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rFIA)
library(dplyr)
library(sf)
library(terra)
library(ggplot2)
```

## Getting and Processing FIA Seedling desnsity data  

###Load FIA tables and clip to most recent inventory years

```{r}
or_fia <- readFIA("C:/Users/Bryce/OneDrive - University Of Oregon/FIA", nCores = 4)
or_fia_clip <- clipFIA(or_fia, mostRecent = TRUE)
rm(or_fia)
#min(or_fia_clip$COND$INVYR)
#min(or_fia$COND$INVYR)
```
### Function to get seedling data from your specific invenotry year
Inputs: year of intrest and the speceis code for speceis of intrest found on FIA appendix F
Output: returns a data table with plot cn, sub plot number, condition id, inveotry year, species code, seedling count used in calulations, trees per arcer (TPA) unadjusted to plot.
```{r}
get_seedling<-function(year, spcd){
  Seedling_df<-or_fia_clip$SEEDLING %>% 
  filter(SPCD == spcd, INVYR == year, !is.na(TREECOUNT_CALC), TREECOUNT_CALC > 0) %>% 
  select(PLT_CN, SUBP, CONDID, INVYR, SPCD, TREECOUNT_CALC, TPA_UNADJ)
  return(Seedling_df)
}
```
Calcuate trees per an acer per plt_cn. In puts
```{r}
seedling_TPA <- function(get_seedling_df){
  get_seedling_df %>% 
    group_by(PLT_CN) %>% 
  summarise(TPA = mean (TPA_UNADJ, na.rm = TRUE))
}
```
Plot level data
```{r}
get_lat_long<-function(year){
  or_fia_clip$PLOT %>%
  filter(INVYR == year) %>% 
  select(PLT_CN, LAT, LON, ELEV) %>%
  filter(!is.na(LAT), !is.na(LON), !is.na(ELEV))
}
```
Get owner information
```{r}
get_owncd<-function(year){
  or_fia$COND %>% 
  filter(INVYR == year) %>% 
  select(PLT_CN,OWNCD, OWNGRPCD)
}
```
Time to join them all together
```{r}
join<-function(tpa_df, lat_long_df, owner_df){
  tpa_df_latlong<-left_join(tpa_df, lat_long_df, by = "PLT_CN") %>% filter(!is.na(TPA), TPA > 0)
  left_join(tpa_df_latlong, owner_df,by = "PLT_CN")
}
```
Go for df to a spacital feature
```{r}
seeding_as_sf<-function(joined_df){
  seedling_sf <- st_as_sf(joined_df, coords = c("LON", "LAT"), crs = 4326)
  return(seedling_sf)
}

```
##Combined all functions 
```{r}
process_seedlings <- function(year, spcd, save_path = NULL) {
  
  # 1. Get seedling records
  Seedling_df <- or_fia_clip$SEEDLING %>%
    filter(SPCD == spcd,
           INVYR == year,
           !is.na(TREECOUNT_CALC)) %>%
    select(PLT_CN, SUBP, CONDID, INVYR, SPCD, TREECOUNT_CALC, TPA_UNADJ)
  
  # 2. Calculate plot-level TPA (sum of TPA_UNADJ across subplots)
  # Note: FIA defines TPA_UNADJ as already count Ã— expansion factor
  Seedling_tpa <- Seedling_df %>%
    group_by(PLT_CN) %>%
    summarise(TPA = sum(TPA_UNADJ, na.rm = TRUE), .groups = "drop")
  
  # 3. Get plot coordinates and elevation
  lat_long_df <- or_fia_clip$PLOT %>%
    filter(INVYR == year) %>%
    select(PLT_CN, LAT, LON, ELEV) %>%
    filter(!is.na(LAT), !is.na(LON), !is.na(ELEV))
  
  # 4. Get ownership info
  owner_df <- or_fia_clip$COND %>%
    filter(INVYR == year) %>%
    select(PLT_CN, OWNCD, OWNGRPCD)
  # 5. Join everything
  joined_df <- Seedling_tpa %>%
    left_join(lat_long_df, by = "PLT_CN") %>%
    filter(!is.na(TPA), TPA > 0) %>%
    left_join(owner_df, by = "PLT_CN")
  
  # 6. Convert to sf object
  seedling_sf <- st_as_sf(joined_df, coords = c("LON", "LAT"), crs = 4326)
  
  # 7. Optionally save to file
  if (!is.null(save_path)) {
    st_write(seedling_sf, save_path, delete_dsn = TRUE)
  }
  
  return(seedling_sf)
}

```
Test Function works, it goes
```{r}
seelding_2022<-process_seedlings(2022, 202)
seelding_2021<-process_seedlings(2021, 202)
seelding_2020<-process_seedlings(2020, 202)
seelding_2019<-process_seedlings(2019, 202)
seelding_2018<-process_seedlings(2018, 202)
seelding_2017<-process_seedlings(2017, 202)
seelding_2016<-process_seedlings(2016, 202)
seelding_2015<-process_seedlings(2015, 202)
seelding_2014<-process_seedlings(2014, 202)
```
bind them all
```{r}
# Add year column to each dataset
seelding_2014 <- seelding_2014 %>% mutate(year = 2014)
seelding_2015 <- seelding_2015 %>% mutate(year = 2015)
seelding_2016 <- seelding_2016 %>% mutate(year = 2016)
seelding_2017 <- seelding_2017 %>% mutate(year = 2017)
seelding_2018 <- seelding_2018 %>% mutate(year = 2018)
seelding_2019 <- seelding_2019 %>% mutate(year = 2019)
seelding_2020 <- seelding_2020 %>% mutate(year = 2020)
seelding_2021 <- seelding_2021 %>% mutate(year = 2021)
seelding_2022 <- seelding_2022 %>% mutate(year = 2022)

# Bind them all together
seedlings_all <- bind_rows(
  seelding_2014, seelding_2015, seelding_2016, seelding_2017,
  seelding_2018, seelding_2019, seelding_2020, seelding_2021, seelding_2022
)

```
all binded, now graphing
```{r}
ggplot(seedlings_all, aes(x = factor(year), y = log10(TPA))) +
  geom_boxplot(fill = "forestgreen", alpha = 0.6, outlier.color = "gray40") +
  labs(
    title = "Annual Seedling Density",
    x = "Year",
    y = "Log10 Trees per Acre (TPA)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

hist
```{r}
#plot(seelding_2022["TPA"], main = "Douglas-fir Seedling Density by Plot")
#Histogram of data
ggplot(seelding_2022, aes(x = TPA)) +
  geom_histogram(binwidth = 100, fill = "forestgreen", color = "white") +
  labs(
    title = "Histogram of Douglas-fir Seedling Density (TPA)",
    x = "Trees per Acre (TPA)",
    y = "Number of Plots"
  ) +
  theme_minimal()
```
```{r}
ggplot(seelding_2022, aes(x = log10(TPA))) +
  geom_histogram(binwidth = 0.1, fill = "forestgreen", color = "white") +
  labs(
    title = "Histogram of Douglas-fir Seedling Density (log10 TPA)",
    x = "log10(Trees per Acre)",
    y = "Number of Plots"
  ) +
  theme_minimal(base_size = 14)
```

Lets use a loop to run through all years 2014-2022 for douglas-fir (202)
```{r}
years<-2014:2022
spcd<-202 #douglas-fir

for(i in years){
  file_saved<- file.path("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf/Douglas_Fir", paste0("Douglas_Fir",i,".gpkg"))
  process_seedlings(year = i, spcd = spcd, save_path = file_saved)
}
```
Again but with Western Hemlock
```{r}
spcd<-263 #Western Hemlock
#Loop with in file path
for(i in years){
  file_saved<- file.path("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf/Western_Hemlock", paste0("Western_Hemlock",i,".gpkg"))
  process_seedlings(year = i, spcd = spcd, save_path = file_saved)
}
```
Third time with Lodge Pole Pine
```{r}
spcd<-108 #LodgePole pine
#Loop with in file path
for(i in years){
  file_saved<- file.path("C:/Users/Bryce/OneDrive - University Of Oregon/Data_Sci/Seedling_Density_BD/data/Seedling_TPA_sf/Lodge_Pole", paste0("Lodge_Pole",i,".gpkg"))
  process_seedlings(year = i, spcd = spcd, save_path = file_saved)
}
```






Counting most surveyed seeds in my study time period to determine which speceis to go with 
```{r}
head(or_fia_clip$SEEDLING)
most_abundant<-or_fia_clip$SEEDLING %>% 
  filter(INVYR >= 2014) %>% 
  select(PLT_CN, SPCD, TREECOUNT_CALC) %>% 
  group_by(SPCD) %>% 
  summarise(sum(TREECOUNT_CALC)) 
  
  most_abundant %>% 
  arrange(desc( `sum(TREECOUNT_CALC)`))
```



